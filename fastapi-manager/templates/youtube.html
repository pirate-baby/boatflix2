{% extends "base.html" %}

{% block title %}YouTube Sync - Media Manager{% endblock %}
{% block nav_youtube %}active{% endblock %}

{% block content %}
<hgroup>
    <h1>YouTube / YouTube Music Sync</h1>
    <p>Sync your YouTube playlists to Jellyfin using browser cookies</p>
</hgroup>

<!-- Cookie Upload Section -->
<article>
    <header>
        <h2>Step 1: Upload YouTube Cookies</h2>
    </header>

    <div id="cookie-status">
        <p aria-busy="true">Loading cookie status...</p>
    </div>

    <details>
        <summary>How to export your YouTube cookies</summary>
        <div style="margin-top: 1rem;">
            <h4>Why cookies?</h4>
            <p>Using browser cookies is the easiest way to access your private YouTube playlists. No OAuth setup, no API keys, and it works offline!</p>

            <h4>Step-by-step instructions:</h4>
            <ol>
                <li><strong>Install a browser extension:</strong>
                    <ul>
                        <li>Chrome/Edge: <a href="https://chrome.google.com/webstore/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc" target="_blank" rel="noopener">Get cookies.txt LOCALLY</a></li>
                        <li>Firefox: <a href="https://addons.mozilla.org/en-US/firefox/addon/cookies-txt/" target="_blank" rel="noopener">cookies.txt</a></li>
                    </ul>
                </li>
                <li><strong>Sign in to YouTube:</strong> Make sure you're logged into your YouTube account</li>
                <li><strong>Export cookies:</strong>
                    <ul>
                        <li>Navigate to <a href="https://www.youtube.com" target="_blank" rel="noopener">youtube.com</a></li>
                        <li>Click the extension icon</li>
                        <li>Click "Export" or "Download" to save the cookies.txt file</li>
                    </ul>
                </li>
                <li><strong>Upload below:</strong> Use the form below to upload your cookies.txt file</li>
            </ol>

            <h4>Security note:</h4>
            <p><small>Your cookies are stored securely on this server and only used to access YouTube on your behalf. They typically stay valid for 6-12 months. You can delete them at any time.</small></p>
        </div>
    </details>

    <form id="cookie-upload-form" style="margin-top: 1rem;">
        <input type="file" id="cookie-file" name="cookie-file" accept=".txt" required>
        <button type="submit">
            <span class="btn-text">Upload Cookies</span>
            <span class="btn-loading" style="display: none;" aria-busy="true"></span>
        </button>
    </form>
</article>

<!-- Add Playlist Section -->
<article id="add-playlist-section" style="display: none;">
    <header>
        <h2>Step 2: Add Playlists</h2>
    </header>

    <p>Enter the URL of a YouTube or YouTube Music playlist to start syncing it.</p>

    <form id="add-playlist-form">
        <label for="playlist-url">
            Playlist URL
            <input type="url" id="playlist-url" name="url" placeholder="https://www.youtube.com/playlist?list=..." required>
            <small>Example: https://www.youtube.com/playlist?list=PLxxx or https://music.youtube.com/playlist?list=PLxxx</small>
        </label>

        <fieldset>
            <legend>Download Type</legend>
            <label>
                <input type="radio" name="download_type" value="audio" checked>
                Audio Only (MP3)
            </label>
            <label>
                <input type="radio" name="download_type" value="video">
                Video (MP4)
            </label>
        </fieldset>

        <button type="submit">
            <span class="btn-text">Add Playlist</span>
            <span class="btn-loading" style="display: none;" aria-busy="true"></span>
        </button>
    </form>
</article>

<!-- Sync Status -->
<article id="sync-status-section" style="display: none;">
    <header>
        <div class="grid">
            <hgroup>
                <h2>Sync Status</h2>
                <p id="sync-status-message">Idle</p>
            </hgroup>
            <div style="text-align: right;">
                <button id="sync-all-btn" onclick="syncAll()" disabled>
                    <span class="btn-text">Sync All Playlists</span>
                    <span class="btn-loading" style="display: none;" aria-busy="true"></span>
                </button>
            </div>
        </div>
    </header>
    <div id="sync-progress" style="display: none;">
        <progress></progress>
        <p id="sync-progress-message"></p>
    </div>
</article>

<!-- Playlists List -->
<div id="playlists-container">
    <!-- Populated by JavaScript -->
</div>

{% endblock %}

{% block scripts %}
<script>
let syncStatusInterval = null;

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadCookieStatus();
    loadPlaylists();

    // Set up cookie upload form
    document.getElementById('cookie-upload-form').addEventListener('submit', uploadCookies);

    // Set up add playlist form
    document.getElementById('add-playlist-form').addEventListener('submit', addPlaylist);

    // Poll sync status
    syncStatusInterval = setInterval(checkSyncStatus, 3000);
    checkSyncStatus();
});

async function loadCookieStatus() {
    try {
        const response = await fetch('/api/youtube/config');
        const config = await response.json();

        const statusDiv = document.getElementById('cookie-status');

        if (config.cookies_uploaded) {
            const uploadedDate = new Date(config.cookies_uploaded_at);
            statusDiv.innerHTML = `
                <div class="grid">
                    <div>
                        <p style="color: var(--pico-ins-color);">‚úì Cookies uploaded</p>
                        <small>Uploaded ${formatRelativeTime(config.cookies_uploaded_at)}</small>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="deleteCookies()" class="outline contrast" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                            Delete Cookies
                        </button>
                    </div>
                </div>
            `;

            // Show add playlist section
            document.getElementById('add-playlist-section').style.display = 'block';
            document.getElementById('sync-status-section').style.display = 'block';
        } else {
            statusDiv.innerHTML = `
                <p style="color: var(--pico-del-color);">‚úó No cookies uploaded yet</p>
                <small>Please upload your YouTube cookies to get started</small>
            `;

            // Hide add playlist section
            document.getElementById('add-playlist-section').style.display = 'none';
            document.getElementById('sync-status-section').style.display = 'none';
        }
    } catch (error) {
        console.error('Failed to load cookie status:', error);
        document.getElementById('cookie-status').innerHTML = '<p class="error">Failed to load status</p>';
    }
}

async function uploadCookies(event) {
    event.preventDefault();

    const form = event.target;
    const fileInput = document.getElementById('cookie-file');
    const submitBtn = form.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a cookies.txt file', 'error');
        return;
    }

    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    // Show loading
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';

    try {
        const response = await fetch('/api/youtube/upload-cookies', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            showToast('Cookies uploaded successfully!', 'success');
            fileInput.value = '';
            loadCookieStatus();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to upload cookies', 'error');
        }
    } catch (error) {
        showToast('Failed to upload cookies', 'error');
        console.error('Upload error:', error);
    } finally {
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
    }
}

async function deleteCookies() {
    if (!confirm('Delete your uploaded YouTube cookies? You will need to upload them again to sync playlists.')) {
        return;
    }

    try {
        const response = await fetch('/api/youtube/cookies', {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Cookies deleted', 'success');
            loadCookieStatus();
            loadPlaylists();
        } else {
            showToast('Failed to delete cookies', 'error');
        }
    } catch (error) {
        showToast('Failed to delete cookies', 'error');
        console.error('Delete error:', error);
    }
}

async function addPlaylist(event) {
    event.preventDefault();

    const form = event.target;
    const url = document.getElementById('playlist-url').value;
    const downloadType = form.querySelector('input[name="download_type"]:checked').value;
    const submitBtn = form.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    // Show loading
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';

    try {
        const response = await fetch('/api/youtube/playlists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                url: url,
                download_type: downloadType
            })
        });

        if (response.ok) {
            showToast('Playlist added successfully! Syncing items in background...', 'success');
            form.reset();
            setTimeout(() => loadPlaylists(), 2000);
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to add playlist', 'error');
        }
    } catch (error) {
        showToast('Failed to add playlist', 'error');
        console.error('Add playlist error:', error);
    } finally {
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
    }
}

async function loadPlaylists() {
    try {
        const response = await fetch('/api/youtube/playlists');
        const playlists = await response.json();

        if (playlists.length === 0) {
            document.getElementById('playlists-container').innerHTML = `
                <article>
                    <p class="muted" style="text-align: center; padding: 2rem;">
                        No playlists added yet.<br>
                        Add a playlist above to get started.
                    </p>
                </article>
            `;
            document.getElementById('sync-all-btn').disabled = true;
            return;
        }

        // Enable sync all button
        document.getElementById('sync-all-btn').disabled = false;

        const playlistsHtml = `
            <article>
                <header>
                    <h2>Your Playlists</h2>
                </header>
                <div class="overflow-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Playlist</th>
                                <th style="text-align: center;">Type</th>
                                <th style="text-align: right;">Items</th>
                                <th style="text-align: right;">Status</th>
                                <th style="text-align: right;">Last Sync</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${playlists.map(playlist => `
                                <tr>
                                    <td>
                                        <a href="/manager/youtube/${playlist.id}">
                                            <strong>${escapeHtml(playlist.title)}</strong>
                                        </a>
                                        <br>
                                        <small class="muted">${escapeHtml(playlist.youtube_playlist_id || 'Unknown ID')}</small>
                                    </td>
                                    <td style="text-align: center;">
                                        <kbd>${playlist.download_type === 'audio' ? 'üéµ Audio' : 'üé¨ Video'}</kbd>
                                    </td>
                                    <td style="text-align: right;">${playlist.item_count}</td>
                                    <td style="text-align: right;">
                                        ${playlist.completed_count > 0 ? `<span style="color: var(--pico-ins-color);">${playlist.completed_count} ‚úì</span>` : ''}
                                        ${playlist.pending_count > 0 ? `<span style="color: var(--pico-secondary);">${playlist.pending_count} ‚è≥</span>` : ''}
                                        ${playlist.failed_count > 0 ? `<span style="color: var(--pico-del-color);">${playlist.failed_count} ‚úó</span>` : ''}
                                        ${playlist.item_count === 0 ? '<span class="muted">-</span>' : ''}
                                    </td>
                                    <td style="text-align: right;">
                                        <small>${playlist.last_synced_at ? formatRelativeTime(playlist.last_synced_at) : 'Never'}</small>
                                    </td>
                                    <td style="text-align: right;">
                                        <button onclick="syncPlaylist('${playlist.id}')" class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                            Sync
                                        </button>
                                        <button onclick="toggleDownloadType('${playlist.id}', '${playlist.download_type}')" class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                            Switch
                                        </button>
                                        <button onclick="deletePlaylist('${playlist.id}')" class="outline contrast" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </article>
        `;

        document.getElementById('playlists-container').innerHTML = playlistsHtml;
    } catch (error) {
        console.error('Failed to load playlists:', error);
        document.getElementById('playlists-container').innerHTML = '<article><p class="error">Failed to load playlists</p></article>';
    }
}

async function checkSyncStatus() {
    try {
        const response = await fetch('/api/youtube/sync/status');
        const status = await response.json();

        if (status.is_running) {
            document.getElementById('sync-progress').style.display = 'block';
            document.getElementById('sync-progress-message').textContent = status.progress_message || 'Syncing...';
            document.getElementById('sync-status-message').textContent = 'Sync in progress';
            document.getElementById('sync-all-btn').disabled = true;
        } else {
            document.getElementById('sync-progress').style.display = 'none';
            document.getElementById('sync-status-message').textContent = status.progress_message || 'Idle';

            // Re-enable sync all button if we have playlists
            const playlistsResponse = await fetch('/api/youtube/playlists');
            const playlists = await playlistsResponse.json();
            document.getElementById('sync-all-btn').disabled = playlists.length === 0;
        }
    } catch (error) {
        console.error('Failed to check sync status:', error);
    }
}

async function syncAll() {
    const btn = document.getElementById('sync-all-btn');
    const btnText = btn.querySelector('.btn-text');
    const btnLoading = btn.querySelector('.btn-loading');

    btn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';

    try {
        const response = await fetch('/api/youtube/sync/all', {
            method: 'POST'
        });

        if (response.ok) {
            showToast('Sync started for all playlists', 'success');
            checkSyncStatus();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to start sync', 'error');
            btn.disabled = false;
        }
    } catch (error) {
        showToast('Failed to start sync', 'error');
        console.error('Sync error:', error);
        btn.disabled = false;
    } finally {
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
    }
}

async function syncPlaylist(playlistId) {
    try {
        const response = await fetch(`/api/youtube/playlists/${playlistId}/sync`, {
            method: 'POST'
        });

        if (response.ok) {
            showToast('Playlist sync started', 'success');
            setTimeout(() => loadPlaylists(), 2000);
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to start sync', 'error');
        }
    } catch (error) {
        showToast('Failed to sync playlist', 'error');
        console.error('Sync error:', error);
    }
}

async function toggleDownloadType(playlistId, currentType) {
    const newType = currentType === 'audio' ? 'video' : 'audio';

    try {
        const response = await fetch(`/api/youtube/playlists/${playlistId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                download_type: newType
            })
        });

        if (response.ok) {
            showToast(`Download type changed to ${newType}`, 'success');
            loadPlaylists();
        } else {
            showToast('Failed to update playlist', 'error');
        }
    } catch (error) {
        showToast('Failed to update playlist', 'error');
        console.error('Update error:', error);
    }
}

async function deletePlaylist(playlistId) {
    if (!confirm('Delete this playlist? This will remove it from sync but will not delete already downloaded files.')) {
        return;
    }

    try {
        const response = await fetch(`/api/youtube/playlists/${playlistId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Playlist deleted', 'success');
            loadPlaylists();
        } else {
            showToast('Failed to delete playlist', 'error');
        }
    } catch (error) {
        showToast('Failed to delete playlist', 'error');
        console.error('Delete error:', error);
    }
}

function formatRelativeTime(isoString) {
    const dt = new Date(isoString);
    const now = new Date();
    const diff = (now - dt) / 1000;

    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
}
</script>
{% endblock %}
